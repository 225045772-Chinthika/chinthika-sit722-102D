name: CI (testing) - Test, Build & Push

on:
  push:
    branches: [ testing ]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/ci-testing.yml"

jobs:
  # -------------------------------
  # Job 1: run backend tests
  # -------------------------------
  test_and_build:
    runs-on: ubuntu-latest
    container: python:3.10

    services:
      product_db:
        image: postgres:14
        env:
          POSTGRES_DB: productdb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ["5432:5432"]   # expose to runner host
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      order_db:
        image: postgres:14
        env:
          POSTGRES_DB: orderdb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ["5433:5432"]   # expose to runner host
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      customer_db:
        image: postgres:14
        env:
          POSTGRES_DB: customerdb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ["5434:5432"]   # expose to runner host
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - uses: actions/checkout@v4

      - name: Install Python deps (base + dev for all services)
        shell: bash
        run: |
          python -m pip install --upgrade pip
          for svc in product_service order_service customer_service; do
            if [ -f backend/$svc/requirements.txt ]; then pip install -r backend/$svc/requirements.txt; fi
            if [ -f backend/$svc/requirements-dev.txt ]; then pip install -r backend/$svc/requirements-dev.txt; fi
          done

      - name: Install Postgres client (for pg_isready)
        run: |
          apt-get update
          apt-get install -y postgresql-client

      - name: Wait for Postgres services to be ready
        shell: bash
        run: |
          # Wait for each published host port
          for port in 5432 5433 5434; do
            echo "Waiting for Postgres at localhost:$port..."
            ready=0
            for i in {1..60}; do
              if pg_isready -h 127.0.0.1 -p "$port" >/dev/null 2>&1; then
                echo "Postgres ready on $port"
                ready=1
                break
              fi
              sleep 2
            done
            [ $ready -eq 1 ] || { echo "Postgres not ready on $port in time"; exit 1; }
          done

      - name: Run backend tests
        shell: bash
        run: |
          set -e
          for svc in product_service order_service customer_service; do
            # Build the correct DB URL for each service (match the ports we exposed)
            if   [ "$svc" = "product_service"  ]; then DBURL="postgresql://postgres:postgres@127.0.0.1:5432/productdb"
            elif [ "$svc" = "order_service"    ]; then DBURL="postgresql://postgres:postgres@127.0.0.1:5433/orderdb"
            elif [ "$svc" = "customer_service" ]; then DBURL="postgresql://postgres:postgres@127.0.0.1:5434/customerdb"
            fi

            if [ -d backend/$svc/tests ]; then
              echo "Running tests in $svc using $DBURL"
              DATABASE_URL="$DBURL" pytest backend/$svc/tests
            else
              echo "No tests for $svc â€“ skipping"
            fi
          done

  # -------------------------------------------
  # Job 2: build and push images to ACR (only if tests pass)
  # -------------------------------------------
  push_images:
    runs-on: ubuntu-latest
    needs: test_and_build

    steps:
      - uses: actions/checkout@v4

      - name: Azure login (SP)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR login and derive vars
        shell: bash
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}
          echo "ACR_LOGIN_SERVER=$(az acr show -n ${{ secrets.ACR_NAME }} --query loginServer -o tsv)" >> $GITHUB_ENV
          echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Build & push images (backends + frontend)
        shell: bash
        run: |
          set -e
          for image in product_service order_service customer_service frontend; do
            CONTEXT=$( [[ "$image" == "frontend" ]] && echo frontend || echo backend/$image )
            docker build -t $ACR_LOGIN_SERVER/$image:$IMAGE_TAG "$CONTEXT"
            docker push $ACR_LOGIN_SERVER/$image:$IMAGE_TAG

            # also tag and push 'latest' (useful for staging)
            docker tag  $ACR_LOGIN_SERVER/$image:$IMAGE_TAG $ACR_LOGIN_SERVER/$image:latest
            docker push $ACR_LOGIN_SERVER/$image:latest
          done